steps:
- id: 'Git repo'
  name: 'alpine'
  entrypoint: 'sh'
  dir: $REPO_NAME
  args: 
  - '-c'
  - | 
      echo "***********************"
      echo "$REPO_NAME"
      echo "$BRANCH_NAME"
      echo "***********************"
      pwd
      mv -v /workspace/* /workspace/$REPO_NAME/
      ls

- id: 'Git clone deploy repo'
  name: 'alpine/git'
  entrypoint: 'sh'
  dir: /workspace
  args: 
  - '-c'
  - | 
      git config --global user.name "Michael Bychkowski"
      git config --global user.email "mbychkowski@google.com"
      git clone https://$$GITOPS_DEPLOY_GH_USERNAME:$$GITOPS_DEPLOY_GH_TOKEN@github.com/mbychkowski/gcp-config-controller-deploy.git
      ls
  secretEnv: ['GITOPS_DEPLOY_GH_TOKEN', 'GITOPS_DEPLOY_GH_USERNAME']

# - id: 'Git clone deploy repo'
#   name: 'alpine/git'
#   entrypoint: 'sh'
#   dir: /workspace
#   args: 
#   - '-c'
#   - | 

- id: "Deploy GitOps blueprint"
  name: gcr.io/google.com/cloudsdktool/cloud-sdk:latest
  dir: /workspace
  entrypoint: /bin/bash
  args:
    - '-c'
    - |
        cd $REPO_NAME
        kpt fn render ./gitops
        git status
        kubectl apply --wait -f ./gitops --recursive
        kubectl wait --for=condition=READY --timeout=300s -f ./gitops/source-repositories.yaml
  waitFor: ["Git repo"]

availableSecrets:
  secretManager:
    - versionName: projects/${PROJECT_ID}/secrets/GITOPS_DEPLOY_GH_TOKEN/versions/latest
      env: GITOPS_DEPLOY_GH_TOKEN
    - versionName: projects/${PROJECT_ID}/secrets/GITOPS_DEPLOY_GH_USERNAME/versions/latest
      env: GITOPS_DEPLOY_GH_USERNAME      
